name: CI Build & Test

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    name: Build & Test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build project
        run: ./gradlew build -x test --stacktrace

      - name: Run tests
        run: ./gradlew test --stacktrace

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/test-results/
          retention-days: 30

      - name: Publish test report
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: build/test-results/**/TEST-*.xml
          check_name: Test Results

      - name: Upload test HTML reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: build/reports/tests/
          retention-days: 30

      - name: Create test summary comment
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let testSummary = '## ðŸ“‹ Build & Test Results\n\n';
            let hasTestResults = false;
            
            try {
              const testResultsPath = 'build/test-results/test';
              if (fs.existsSync(testResultsPath)) {
                const files = fs.readdirSync(testResultsPath);
                const xmlFiles = files.filter(f => f.endsWith('.xml'));
                
                if (xmlFiles.length > 0) {
                  hasTestResults = true;
                  testSummary += `### ðŸ“Š Test Files Found\n`;
                  testSummary += `- **Count**: ${xmlFiles.length}\n`;
                  testSummary += `- **Format**: JUnit XML\n\n`;
                }
              }
            } catch (e) {
              console.log('No XML test results found');
            }
            
            if (!hasTestResults) {
              testSummary += '### âœ… Build Completed\n';
              testSummary += '- Tests executed successfully\n';
              testSummary += '- See "Test Results" check for details\n\n';
            }
            
            testSummary += '### ðŸ“¦ Artifacts\n';
            testSummary += '- Test results available in job artifacts\n';
            testSummary += '- Test HTML reports available in job artifacts\n\n';
            testSummary += '---\n';
            testSummary += '*Generated by GitHub Actions*\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: testSummary
            })

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            build/reports/
            .gradle/
          retention-days: 7

  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality Checks
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Check code style
        run: ./gradlew check --stacktrace || true

      - name: Upload code quality reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-reports
          path: build/reports/
          retention-days: 30

  dependency-check:
    runs-on: ubuntu-latest
    name: Dependency Vulnerability Check
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Check for dependency vulnerabilities
        run: ./gradlew dependencyCheckAnalyze --stacktrace || true

      - name: Upload dependency check reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-reports
          path: build/reports/dependency-check/
          retention-days: 30

